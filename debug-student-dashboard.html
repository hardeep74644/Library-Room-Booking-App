<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Student Dashboard - KPU Library</title>
    <link rel="stylesheet" href="css/style.css?v=2.0">
</head>

<body style="background: #f5f7fa;">
    <div class="dashboard">
        <!-- Header -->
        <div class="dashboard-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üìö Debug Student Dashboard</h1>
                    <p class="user-info">Welcome, <strong id="user-name">Loading...</strong></p>
                    <div id="debug-info"
                        style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <h4>Debug Information:</h4>
                        <p id="auth-status">Authentication: Checking...</p>
                        <p id="user-id">User ID: Not loaded</p>
                        <p id="user-role">User Role: Not loaded</p>
                        <p id="bookings-status">Bookings: Not loaded</p>
                    </div>
                </div>
                <button onclick="logout()"
                    style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">Logout</button>
            </div>
        </div>

        <!-- Debug Console -->
        <div class="card">
            <h2>üêõ Debug Console</h2>
            <div id="debug-console"
                style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; max-height: 200px; overflow-y: auto;">
                <p>Debug console initialized...</p>
            </div>
            <button onclick="testBookingsQuery()"
                style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px;">Test
                Bookings Query</button>
            <button onclick="testSimpleQuery()"
                style="margin-top: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px;">Test
                Simple Query</button>
        </div>

        <!-- My Bookings Section -->
        <div class="card">
            <h2>üìã My Current Booking</h2>
            <div id="my-bookings">
                <table>
                    <thead>
                        <tr>
                            <th>Room Number</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Duration</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="bookings-table">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #999;">Loading bookings...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase-config.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import {
            collection,
            getDocs,
            getDoc,
            doc,
            setDoc,
            query,
            where,
            deleteDoc,
            orderBy
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        let currentUser = null;

        function debugLog(message) {
            const console = document.getElementById('debug-console');
            const timestamp = new Date().toLocaleTimeString();
            console.innerHTML += `<p>[${timestamp}] ${message}</p>`;
            console.scrollTop = console.scrollHeight;
            console.log(message);
        }

        // Update debug info
        function updateDebugInfo(key, value) {
            const element = document.getElementById(key);
            if (element) {
                element.textContent = element.textContent.split(':')[0] + ': ' + value;
            }
        }

        // Check authentication
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                debugLog('‚úÖ User authenticated: ' + user.email);
                updateDebugInfo('auth-status', 'Authenticated');
                updateDebugInfo('user-id', user.uid);

                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    const userData = userDoc.data();

                    if (!userData) {
                        debugLog('‚ö†Ô∏è User document not found, creating default...');
                        await setDoc(doc(db, 'users', user.uid), {
                            name: user.displayName || user.email,
                            email: user.email,
                            role: 'student',
                            createdAt: new Date().toISOString()
                        });
                        userData = { role: 'student', name: user.displayName || user.email };
                    }

                    debugLog('‚úÖ User data loaded: ' + JSON.stringify(userData));
                    updateDebugInfo('user-role', userData.role || 'unknown');

                    // Update welcome message
                    document.getElementById('user-name').textContent = userData?.name || user.email;

                    // Check if user is a student
                    if (userData?.role !== 'student') {
                        debugLog('‚ùå Access denied - not a student role');
                        alert('Access denied. This page is for students only.');
                        window.location.href = 'admin-dashboard.html';
                        return;
                    }

                    // Load user's bookings
                    debugLog('üîÑ Loading user bookings...');
                    loadMyBookings();

                } catch (error) {
                    debugLog('‚ùå Error loading user data: ' + error.message);
                    updateDebugInfo('auth-status', 'Error: ' + error.message);
                }
            } else {
                debugLog('‚ùå No user authenticated, redirecting to login');
                updateDebugInfo('auth-status', 'Not authenticated');
                window.location.href = 'login.html';
            }
        });

        // Load user's bookings
        async function loadMyBookings() {
            if (!currentUser) {
                debugLog('‚ùå No current user for loading bookings');
                return;
            }

            try {
                debugLog('üîÑ Starting to load bookings for user: ' + currentUser.uid);
                const bookingsRef = collection(db, 'bookings');

                updateDebugInfo('bookings-status', 'Loading...');

                // Try the complex query first
                let q;
                try {
                    debugLog('üîÑ Attempting complex query with orderBy...');
                    q = query(
                        bookingsRef,
                        where('userId', '==', currentUser.uid),
                        where('status', '==', 'active'),
                        orderBy('createdAt', 'desc')
                    );
                } catch (indexError) {
                    debugLog('‚ö†Ô∏è Complex query failed, using simpler query: ' + indexError.message);
                    // Fallback to simpler query if index doesn't exist
                    q = query(
                        bookingsRef,
                        where('userId', '==', currentUser.uid),
                        where('status', '==', 'active')
                    );
                }

                debugLog('üîÑ Executing query...');
                const snapshot = await getDocs(q);
                debugLog('‚úÖ Query executed successfully, found ' + snapshot.size + ' documents');

                const bookingsTable = document.getElementById('bookings-table');

                if (snapshot.empty) {
                    debugLog('‚ÑπÔ∏è No active bookings found');
                    bookingsTable.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No active bookings</td></tr>';
                    updateDebugInfo('bookings-status', 'No bookings found');
                    return;
                }

                debugLog('‚úÖ Processing ' + snapshot.size + ' bookings...');
                bookingsTable.innerHTML = '';

                snapshot.forEach(doc => {
                    const booking = doc.data();
                    debugLog('üìã Processing booking: ' + JSON.stringify(booking));

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>Room ${booking.roomNumber}</td>
                        <td>${booking.date}</td>
                        <td>${booking.startTime} - ${booking.endTime}</td>
                        <td>${calculateDuration(booking.startTime, booking.endTime)}</td>
                        <td><span class="status-active">Active</span></td>
                        <td><button class="btn-danger" onclick="cancelBooking('${doc.id}')">Cancel</button></td>
                    `;
                    bookingsTable.appendChild(row);
                });

                updateDebugInfo('bookings-status', 'Loaded ' + snapshot.size + ' bookings');
                debugLog('‚úÖ Bookings loaded successfully');

            } catch (error) {
                debugLog('‚ùå Error loading bookings: ' + error.message);
                debugLog('‚ùå Error stack: ' + error.stack);
                updateDebugInfo('bookings-status', 'Error: ' + error.message);

                // Show fallback message
                const bookingsTable = document.getElementById('bookings-table');
                bookingsTable.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #dc3545;">Error loading bookings: ${error.message}</td></tr>`;
            }
        }

        // Test functions
        window.testBookingsQuery = async function () {
            if (!currentUser) {
                debugLog('‚ùå No authenticated user for test');
                return;
            }

            try {
                debugLog('üß™ Testing bookings query...');
                const bookingsRef = collection(db, 'bookings');
                const q = query(bookingsRef, where('userId', '==', currentUser.uid));
                const snapshot = await getDocs(q);
                debugLog('‚úÖ Test query successful, found ' + snapshot.size + ' total bookings');

                snapshot.forEach(doc => {
                    const booking = doc.data();
                    debugLog('üìã Booking: ' + JSON.stringify(booking));
                });
            } catch (error) {
                debugLog('‚ùå Test query failed: ' + error.message);
            }
        };

        window.testSimpleQuery = async function () {
            try {
                debugLog('üß™ Testing simple collection access...');
                const bookingsRef = collection(db, 'bookings');
                const snapshot = await getDocs(bookingsRef);
                debugLog('‚úÖ Simple query successful, found ' + snapshot.size + ' total documents in collection');
            } catch (error) {
                debugLog('‚ùå Simple query failed: ' + error.message);
            }
        };

        // Calculate duration for display
        function calculateDuration(startTime, endTime) {
            const [startHours, startMinutes] = startTime.split(':').map(Number);
            const [endHours, endMinutes] = endTime.split(':').map(Number);

            const totalMinutes = (endHours * 60 + endMinutes) - (startHours * 60 + startMinutes);

            if (totalMinutes >= 60) {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return minutes > 0 ? `${hours}h ${minutes}m` : `${hours}h`;
            }

            return `${totalMinutes}m`;
        }

        // Cancel booking
        window.cancelBooking = async function (bookingId) {
            if (!confirm('Are you sure you want to cancel this booking?')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'bookings', bookingId));
                debugLog('‚úÖ Booking cancelled successfully');
                alert('Booking cancelled successfully');
                loadMyBookings();
            } catch (error) {
                debugLog('‚ùå Error cancelling booking: ' + error.message);
                alert('Failed to cancel booking. Please try again.');
            }
        };

        // Logout
        window.logout = async function () {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = 'login.html';
                } catch (error) {
                    debugLog('‚ùå Logout error: ' + error.message);
                    alert('Failed to logout. Please try again.');
                }
            }
        };

        debugLog('üöÄ Debug dashboard initialized');
    </script>
</body>

</html>